# Чат-дерево

Чат, который поддерживает древовидную структуру и отправку сообщения всем узлам.

## Протокол

### Общая структура пакета

(UUID пакета)(порт отправителя)(ID типа пакета)(полезная нагрузка)

* UUID пакета - Уникальный идентификатор пакета в виде 2-х блоков `long`
* Порт отправителя - Порт приложения отправителя на который отправитель ждет ответ
* ID типа пакета - Уникальный идентификатор типа пакета (список типов ниже)
* Полезная нагрузка - Различные данные в зависимости от типа пакета

### Типы пакетов

Ниже перечислены типы пакетов, их уникальные идентификаторы и описание полезной
нагрузки для каждого типа.

#### Text (0)

**Описание:** Передает новое текстовое сообщение.

**Полезная нагрузка:** Текст сообщения.

#### AcceptText (1)

**Описание:** Уведомляет отправителя пакета `Text` о том, что пакет успешно получен.

**Полезная нагрузка:** UUID пакета `Text` в виде двух `long`, который был отправлен.

#### Hello (2)

**Описание:** Уведомляет получателя о том, что отправитель является его потомком.

**Полезная нагрузка:** Отсутствует.

#### AcceptHello (3)

**Описание:** Уведомляет отправителя пакета `Hello` о том, что пакет успешно получен.

**Полезная нагрузка:** UUID пакета `Hello` в виде двух `long`, который был отправлен.

## Схема работы

### Термины

* **Повторяющееся сообщение** - Данное сообщение будет повторяться до тех пор пока
не закончится фиксированное количество попыток, либо не будет получено подтверждение
о получении.

### Алгоритм

* Если в аргументах при запуске узла указан его предок, узел отправляет повторяющееся
сообщение `Hello` по адресу своего предка и затем ждет ввод пользователя.
* При получении пакета `Hello`, узел запоминает отправителя как дочерний узел и
отправляет в ответ `AcceptHello`. Если узел уже отмечен как дочерний, ответ все-равно
должен быть отправлен.
* При получении пакета `AcceptHello`, узел отменяет повтор отправки сообщения `Hello`
и запоминает узел отправитель как родительский.
* Как только пользователь вводит строку текста, узел отправляет всем своим дочерним
узлам и узлу предку повторяющееся сообщение `Text` с введенным пользователем текстом.
* При получении пакета `Text`, узел отправляет в ответ пакет `AcceptText` и проверяет,
есть ли в его истории сообщение с данным UUID. Если такое сообщение не найдено, то
узел рассылает пакет `Text` с тем же сообщением и UUID, которые были получены, а
также запоминает UUID в истории сообщений.
* При получении пакета `AcceptText`, узел отменяет повтор отправки сообщения `Text`.